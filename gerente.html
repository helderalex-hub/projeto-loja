<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Financeira | Beleza & Companhia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --dark: #1a1a1a; --card: #2d2d2d; --rosa: #d63384; --texto: #f5f5f5; --verde: #28a745; --azul: #2196F3; --amarelo: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--texto); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: var(--rosa); text-align: center; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }
        
        /* Dashboards Novos */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card-dash { background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #444; }
        .card-dash h3 { font-size: 13px; color: #aaa; text-transform: uppercase; margin: 0; }
        .card-dash p { font-size: 24px; font-weight: bold; margin: 10px 0 0; }
        .val-fatura { color: var(--azul); }
        .val-custo { color: var(--amarelo); }
        .val-margem { color: var(--verde); }

        /* Form com C√¢mara */
        .card-form { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #444; margin-bottom: 30px; }
        .camera-box { text-align: center; margin-bottom: 20px; }
        #preview-nova-foto { 
            width: 140px; height: 140px; border-radius: 50%; object-fit: cover; 
            border: 3px dashed #555; cursor: pointer; background: #111; transition: 0.3s;
        }
        #preview-nova-foto:hover { border-color: var(--rosa); }
        
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-size: 11px; color: #888; text-transform: uppercase; }
        input { width: 100%; padding: 12px; margin: 5px 0 15px; border-radius: 8px; border: 1px solid #444; background: #111; color: white; box-sizing: border-box; }
        
        #btnSalvar { background: var(--rosa); color: white; border: none; padding: 18px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* Lista de Produtos */
        .item { background: var(--card); padding: 15px; margin-top: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid #444; }
        .img-lista { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .info { flex-grow: 1; }
        .info strong { color: var(--rosa); }
        .btn-edit { background: var(--azul); border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: white; }
        .btn-del { background: #ff4444; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: white; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üíé Painel Financeiro</h1>
        
        <div class="dashboard">
            <div class="card-dash">
                <h3>Fatura√ß√£o Estimada</h3>
                <p id="dash-fatura" class="val-fatura">‚Ç¨ 0.00</p>
            </div>
            <div class="card-dash">
                <h3>Custo Total Stock</h3>
                <p id="dash-custo" class="val-custo">‚Ç¨ 0.00</p>
            </div>
            <div class="card-dash">
                <h3>Margem Estimada (Lucro)</h3>
                <p id="dash-margem" class="val-margem">‚Ç¨ 0.00</p>
            </div>
        </div>

        <div class="card-form">
            <div class="camera-box">
                <img id="preview-nova-foto" src="https://via.placeholder.com/150?text=FOTO" title="Clique para abrir c√¢mara">
                <input type="file" id="foto-input" accept="image/*" capture="environment" style="display: none;">
            </div>

            <label>Nome do Produto</label>
            <input type="text" id="nome">
            
            <div class="grid-form">
                <div><label>Pre√ßo Custo (‚Ç¨)</label><input type="number" id="preco_entrada" step="0.01"></div>
                <div><label>Pre√ßo Venda (‚Ç¨)</label><input type="number" id="preco" step="0.01"></div>
                <div><label>Stock Inicial</label><input type="number" id="estoque"></div>
            </div>
            
            <button id="btnSalvar">ADICIONAR AO INVENT√ÅRIO</button>
        </div>

        <div id="lista">A carregar invent√°rio financeiro...</div>
    </div>

    <script>
        const API = 'https://projeto-loja-dzqv.onrender.com/produtos';
        const S_URL = 'https://sgamfzcgiexoevnyiehn.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYW1memNnaWV4b2V2bnlpZWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzIwMDYsImV4cCI6MjA4NDUwODAwNn0.BLdnOWXEpW6w_Ic_0stcOexXXQBWl7Rc5ll0ATjvZVs';
        const supabaseClient = window.supabase.createClient(S_URL, S_KEY);

        // L√≥gica de Foto
        const preview = document.getElementById('preview-nova-foto');
        const fileInput = document.getElementById('foto-input');
        preview.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => preview.src = e.target.result;
                reader.readAsDataURL(this.files[0]);
            }
        });

        async function carregarDados() {
            try {
                const res = await fetch(API);
                const produtos = await res.json();
                const div = document.getElementById('lista');
                div.innerHTML = '';

                let totalFatura = 0;
                let totalCusto = 0;

                produtos.forEach(p => {
                    const custo = parseFloat(p.preco_entrada || 0);
                    const venda = parseFloat(p.preco || 0);
                    const qtd = parseInt(p.estoque || 0);

                    totalFatura += (venda * qtd);
                    totalCusto += (custo * qtd);

                    const item = document.createElement('div');
                    item.className = 'item';
                    item.innerHTML = `
                        <img src="${p.imagem || 'https://via.placeholder.com/60'}" class="img-lista">
                        <div class="info">
                            <strong>${p.nome}</strong>
                            <p>Venda: ‚Ç¨${venda.toFixed(2)} | Stock: ${qtd}</p>
                            <p style="font-size:11px; color:#888">Custo Unit√°rio: ‚Ç¨${custo.toFixed(2)}</p>
                        </div>
                        <div>
                            <button class="btn-edit" onclick="editar('${p.id}', '${p.nome}', ${venda}, ${custo}, ${qtd})">‚úèÔ∏è</button>
                            <button class="btn-del" onclick="deletar('${p.id}')">üóëÔ∏è</button>
                        </div>
                    `;
                    div.appendChild(item);
                });

                const totalMargem = totalFatura - totalCusto;

                document.getElementById('dash-fatura').innerText = '‚Ç¨ ' + totalFatura.toFixed(2);
                document.getElementById('dash-custo').innerText = '‚Ç¨ ' + totalCusto.toFixed(2);
                document.getElementById('dash-margem').innerText = '‚Ç¨ ' + totalMargem.toFixed(2);
            } catch (e) { console.error(e); }
        }

        document.getElementById('btnSalvar').addEventListener('click', async () => {
            const btn = document.getElementById('btnSalvar');
            const nome = document.getElementById('nome').value;
            const custo = document.getElementById('preco_entrada').value;
            const venda = document.getElementById('preco').value;
            const estoque = document.getElementById('estoque').value;
            const arquivo = fileInput.files[0];

            if(!nome || !venda) return alert("Preencha os campos obrigat√≥rios.");
            btn.innerText = "A guardar..."; btn.disabled = true;

            let urlImg = "";
            if(arquivo) {
                const nomeArq = `${Date.now()}_prod.jpg`;
                const { data, error } = await supabaseClient.storage.from('fotos-produtos').upload(nomeArq, arquivo);
                if(!error) {
                    const { data: l } = supabaseClient.storage.from('fotos-produtos').getPublicUrl(nomeArq);
                    urlImg = l.publicUrl;
                }
            }

            await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    nome, 
                    preco_entrada: parseFloat(custo) || 0, 
                    preco: parseFloat(venda), 
                    estoque: parseInt(estoque) || 0, 
                    imagem: urlImg 
                })
            });
            location.reload();
        });

        async function editar(id, nome, venda, custo, estoque) {
            const nVenda = prompt("Novo Pre√ßo Venda:", venda);
            const nCusto = prompt("Novo Pre√ßo Custo:", custo);
            const nStock = prompt("Novo Stock:", estoque);
            if(nVenda !== null) {
                await fetch(`${API}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        nome, 
                        preco: parseFloat(nVenda), 
                        preco_entrada: parseFloat(nCusto), 
                        estoque: parseInt(nStock) 
                    })
                });
                carregarDados();
            }
        }

        async function deletar(id) {
            if(confirm("Deseja apagar este produto?")) {
                await fetch(`${API}/${id}`, { method: 'DELETE' });
                carregarDados();
            }
        }

        window.onload = carregarDados;
    </script>
</body>
</html>
