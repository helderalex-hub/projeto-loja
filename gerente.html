<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Painel do Gerente | Beleza & Cia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #fff0f5; }
        .dashboard { display: flex; gap: 15px; margin-bottom: 25px; }
        .card-dash { flex: 1; background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-bottom: 4px solid #ddd; }
        .card-dash h3 { margin: 0; color: #666; font-size: 14px; text-transform: uppercase; }
        .card-dash p { margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #333; }
        .borda-rosa { border-color: #d63384; color: #d63384; }
        .borda-verde { border-color: #28a745; color: #28a745; }
        .borda-vermelha { border-color: #dc3545; color: #dc3545; }
        .card-form { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 30px;}
        input { display: block; margin: 5px 0 15px 0; padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 13px; color: #555; }
        .btn-add { background: #d63384; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s;}
        .item { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .status-ok { border-left-color: #28a745; }
        .status-atencao { border-left-color: #ffc107; background-color: #fff9e6; } 
        .status-vencido { border-left-color: #dc3545; background-color: #ffe6e6; }
        .btn-mini { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin-left: 5px; color: white; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h1 style="color: #d63384; margin:0;">üíÑ √Årea do Gerente</h1>
        <div>
            <a href="index.html" style="text-decoration:none; color:#d63384; font-weight:bold; margin-right: 15px;">Ver Loja</a>
            <button onclick="sair()" style="background:#666; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Sair üîí</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="card-dash borda-rosa"><h3>Produtos</h3><p id="dash-qtd">0</p></div>
        <div class="card-dash borda-verde"><h3>Valor Total</h3><p id="dash-valor">‚Ç¨ 0,00</p></div>
        <div class="card-dash borda-vermelha"><h3>Vencidos</h3><p id="dash-vencidos">0</p></div>
    </div>
    
    <div class="card-form">
        <label>Nome do Produto:</label>
        <input type="text" id="nome" placeholder="Ex: Batom Matte" />
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;"><label>Pre√ßo (‚Ç¨):</label><input type="number" id="preco" step="0.01" /></div>
            <div style="flex: 1;"><label>Estoque:</label><input type="number" id="estoque" /></div>
        </div>
        <label>Validade:</label>
        <input type="date" id="validade" />
        <button class="btn-add" onclick="salvarProduto()">SALVAR PRODUTO</button>
    </div>

    <h3 style="color: #555;">üì¶ Invent√°rio</h3>
    <div id="lista">A verificar seguran√ßa...</div>

    <script>
        const S_URL = 'https://sgamfzcgiexoevnyiehn.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYW1memNnaWV4b2V2bnlpZWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzIwMDYsImV4cCI6MjA4NDUwODAwNn0.BLdnOWXEpW6w_Ic_0stcOexXXQBWl7Rc5ll0ATjvZVs';
        const API = 'https://projeto-loja-dzqv.onrender.com/produtos';

        const supabase = window.supabase.createClient(S_URL, S_KEY);

        async function verificarAcesso() {
            const { data } = await supabase.auth.getSession();
            if (!data.session) {
                window.location.href = 'login.html';
            } else {
                carregarLista();
            }
        }

        async function sair() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        async function carregarLista() {
            const divLista = document.getElementById('lista');
            divLista.innerHTML = "Carregando produtos...";
            try {
                const resposta = await fetch(API);
                const produtos = await resposta.json();
                divLista.innerHTML = '';

                let totalItens = 0, valorTotal = 0, qtdVencidos = 0;
                const hoje = new Date();
                
                produtos.forEach(p => {
                    totalItens++;
                    const precoNum = parseFloat(p.preco) || 0;
                    valorTotal += (precoNum * (p.estoque || 0));

                    let textoValidade = "Sem data", classeStatus = "status-ok", aviso = "";
                    if (p.validade) {
                        const dataObj = new Date(p.validade);
                        textoValidade = dataObj.toLocaleDateString('pt-PT');
                        if (dataObj < hoje) { classeStatus = "status-vencido"; qtdVencidos++; aviso = "‚ö†Ô∏è VENCIDO"; }
                    }
                    
                    divLista.innerHTML += `
                    <div class="item ${classeStatus}">
                        <div>
                            <strong>${p.nome}</strong> <small style="color:red;">${aviso}</small><br>
                            <span>‚Ç¨ ${precoNum.toFixed(2)} | Qtd: ${p.estoque}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size:12px;">üìÖ ${textoValidade}</span>
                            <div style="margin-top:5px;">
                                <button class="btn-mini" style="background:#2196F3;" onclick="editarProduto(${p.id}, '${p.preco}', '${p.estoque}')">‚úèÔ∏è</button>
                                <button class="btn-mini" style="background:#ff4444;" onclick="deletarProduto(${p.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
                });

                document.getElementById('dash-qtd').innerText = totalItens;
                document.getElementById('dash-valor').innerText = valorTotal.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
                document.getElementById('dash-vencidos').innerText = qtdVencidos;

            } catch (erro) {
                divLista.innerHTML = 'Erro ao carregar dados do servidor. Tente atualizar a p√°gina.';
            }
        }

        async function salvarProduto() {
            const nome = document.getElementById('nome').value;
            const preco = document.getElementById('preco').value;
            const estoque = document.getElementById('estoque').value;
            const validade = document.getElementById('validade').value;
            if(!nome || !preco) return alert("Preencha os dados!");

            await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, preco, estoque, validade })
            });
            carregarLista();
        }

        async function deletarProduto(id) {
            if (confirm("Apagar produto?")) {
                await fetch(`${API}/${id}`, { method: 'DELETE' });
                carregarLista();
            }
        }

        async function editarProduto(id, precoAtual, estoqueAtual) {
            const novoP = prompt("Novo Pre√ßo:", precoAtual);
            const novoE = prompt("Novo Estoque:", estoqueAtual);
            if (novoP !== null && novoE !== null) {
                await fetch(`${API}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preco: novoP, estoque: novoE })
                });
                carregarLista();
            }
        }

        verificarAcesso();
    </script>
</body>
</html>
