<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Admin Stock | Beleza & Companhia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --rosa: #d63384; --texto: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--texto); margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Dashboard Simples */
        .dash { display: flex; gap: 10px; margin-bottom: 20px; }
        .dash-item { background: var(--card); flex: 1; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        
        /* Form */
        .form-box { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #333; }
        .preview-container { text-align: center; margin-bottom: 15px; }
        #preview-foto { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; background: #000; border: 1px solid #444; }
        
        label { display: block; font-size: 12px; color: #888; margin-top: 10px; }
        input { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; }
        
        #btnSalvar { background: var(--rosa); color: #fff; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        #btnSalvar:disabled { opacity: 0.5; }

        /* Lista */
        .item { background: var(--card); padding: 12px; margin-top: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; }
        .img-mini { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        .info { flex: 1; }
        .btn-del { background: #ff4d4d; border: none; padding: 8px; border-radius: 5px; color: #fff; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center">Painel de Gest√£o</h2>

    <div class="dash">
        <div class="dash-item">Custo Total<br><strong id="d-custo">‚Ç¨ 0.00</strong></div>
        <div class="dash-item">Venda Total<br><strong id="d-venda" style="color:var(--rosa)">‚Ç¨ 0.00</strong></div>
    </div>

    <div class="form-box">
        <div class="preview-container">
            <img id="preview-foto" src="https://via.placeholder.com/100?text=FOTO">
            <input type="file" id="foto-input" accept="image/*" style="margin-top:10px; font-size:12px;">
        </div>

        <label>Nome do Produto</label>
        <input type="text" id="nome">

        <div style="display:flex; gap:10px">
            <div style="flex:1">
                <label>Custo (‚Ç¨)</label>
                <input type="number" id="custo" step="0.01" value="0">
            </div>
            <div style="flex:1">
                <label>Venda (‚Ç¨)</label>
                <input type="number" id="venda" step="0.01" value="0">
            </div>
        </div>

        <label>Stock Atual</label>
        <input type="number" id="stock" value="0">

        <button id="btnSalvar">GRAVAR PRODUTO</button>
    </div>

    <div id="lista" style="margin-top:20px"></div>
</div>

<script>
    const API = 'https://projeto-loja-dzqv.onrender.com/produtos';
    const S_URL = 'https://sgamfzcgiexoevnyiehn.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYW1memNnaWV4b2V2bnlpZWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzIwMDYsImV4cCI6MjA4NDUwODAwNn0.BLdnOWXEpW6w_Ic_0stcOexXXQBWl7Rc5ll0ATjvZVs';
    
    const client = window.supabase.createClient(S_URL, S_KEY);

    const fInput = document.getElementById('foto-input');
    const fPrev = document.getElementById('preview-foto');

    // SOLU√á√ÉO PARA O PISCAR: ObjectURL √© instant√¢neo
    fInput.onchange = () => {
        const file = fInput.files[0];
        if (file) {
            fPrev.src = URL.createObjectURL(file);
        }
    };

    async function carregar() {
        try {
            const r = await fetch(API);
            const dados = await r.json();
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            
            let cT = 0, vT = 0;

            dados.forEach(p => {
                const c = parseFloat(p.preco_entrada || 0), v = parseFloat(p.preco || 0), s = parseInt(p.estoque || 0);
                cT += (c * s); vT += (v * s);
                
                lista.innerHTML += `
                    <div class="item">
                        <img src="${p.imagem || ''}" class="img-mini" onerror="this.src='https://via.placeholder.com/50'">
                        <div class="info">
                            <strong>${p.nome}</strong><br>
                            <small>Stock: ${s} | Venda: ‚Ç¨${v.toFixed(2)}</small>
                        </div>
                        <button class="btn-del" onclick="apagar('${p.id}')">üóëÔ∏è</button>
                    </div>`;
            });

            document.getElementById('d-custo').innerText = '‚Ç¨ ' + cT.toFixed(2);
            document.getElementById('d-venda').innerText = '‚Ç¨ ' + vT.toFixed(2);
        } catch (e) { console.log("Erro ao carregar lista"); }
    }

    document.getElementById('btnSalvar').onclick = async () => {
        const btn = document.getElementById('btnSalvar');
        const nome = document.getElementById('nome').value;
        if (!nome) return alert("Nome obrigat√≥rio");

        btn.disabled = true;
        btn.innerText = "A GUARDAR NO SUPABASE...";

        try {
            let url = "";
            const file = fInput.files[0];

            if (file) {
                const path = Date.now() + ".jpg";
                const { error } = await client.storage.from('fotos-produtos').upload(path, file);
                if (!error) {
                    const { data } = client.storage.from('fotos-produtos').getPublicUrl(path);
                    url = data.publicUrl;
                }
            }

            const res = await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nome,
                    preco: parseFloat(document.getElementById('venda').value) || 0,
                    preco_entrada: parseFloat(document.getElementById('custo').value) || 0,
                    estoque: parseInt(document.getElementById('stock').value) || 0,
                    imagem: url
                })
            });

            if (res.ok) {
                alert("Produto guardado!");
                location.reload();
            } else {
                alert("Erro ao gravar. Verifique o servidor.");
            }
        } catch (e) {
            alert("Erro de rede.");
        } finally {
            btn.disabled = false;
            btn.innerText = "GRAVAR PRODUTO";
        }
    };

    async function apagar(id) {
        if (confirm("Apagar produto?")) {
            await fetch(API + '/' + id, { method: 'DELETE' });
            carregar();
        }
    }

    window.onload = carregar;
</script>

</body>
</html>
