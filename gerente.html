<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Painel do Gerente | Beleza & Cia</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #fff0f5; }
        
        /* DASHBOARD */
        .dashboard { display: flex; gap: 15px; margin-bottom: 25px; }
        .card-dash { flex: 1; background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-bottom: 4px solid #ddd; }
        .card-dash h3 { margin: 0; color: #666; font-size: 14px; text-transform: uppercase; }
        .card-dash p { margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #333; }
        
        /* CORES */
        .borda-rosa { border-color: #d63384; color: #d63384; }
        .borda-verde { border-color: #28a745; color: #28a745; }
        .borda-vermelha { border-color: #dc3545; color: #dc3545; }

        /* FORMUL√ÅRIO */
        .card-form { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 30px;}
        input { display: block; margin: 5px 0 15px 0; padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 13px; color: #555; }
        
        .btn-add { background: #d63384; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s;}
        .btn-add:hover { background: #c2185b; }

        /* LISTA DE PRODUTOS */
        .item { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        
        .status-ok { border-left-color: #28a745; }
        .status-atencao { border-left-color: #ffc107; background-color: #fff9e6; } 
        .status-vencido { border-left-color: #dc3545; background-color: #ffe6e6; }

        .btn-mini { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin-left: 5px; color: white; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="color: #d63384;">üíÑ √Årea do Gerente</h1>
        <a href="index.html" style="text-decoration:none; color:#d63384; font-weight:bold;">Ir para a Loja ‚ûî</a>
    </div>

    <div class="dashboard">
        <div class="card-dash borda-rosa">
            <h3>Produtos</h3>
            <p id="dash-qtd">0</p>
        </div>
        <div class="card-dash borda-verde">
            <h3>Valor em Estoque</h3>
            <p id="dash-valor">‚Ç¨ 0,00</p>
        </div>
        <div class="card-dash borda-vermelha">
            <h3>Vencidos / Alerta</h3>
            <p id="dash-vencidos">0</p>
        </div>
    </div>
    
    <div class="card-form">
        <label>Nome do Produto:</label>
        <input type="text" id="nome" placeholder="Ex: Base L√≠quida" />
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Pre√ßo (‚Ç¨):</label>
                <input type="number" id="preco" placeholder="0.00" step="0.01" />
            </div>
            <div style="flex: 1;">
                <label>Qtd em Estoque:</label>
                <input type="number" id="estoque" placeholder="0" />
            </div>
        </div>
        <label>Data de Validade:</label>
        <input type="date" id="validade" />
        
        <button class="btn-add" onclick="salvarProduto()">SALVAR PRODUTO</button>
    </div>

    <h3 style="color: #555;">üì¶ Invent√°rio Detalhado</h3>
    <div id="lista">Carregando...</div>

    <script>
        // --- CONEX√ÉO COM O SERVIDOR ---
        const API = 'https://projeto-loja-dzqv.onrender.com/produtos';

        async function carregarLista() {
            try {
                const resposta = await fetch(API);
                const produtos = await resposta.json();
                
                const divLista = document.getElementById('lista');
                divLista.innerHTML = '';

                let totalItens = 0;
                let valorTotal = 0;
                let qtdVencidos = 0;
                const hoje = new Date();
                
                produtos.forEach(p => {
                    totalItens += 1;
                    const precoNum = parseFloat(p.preco);
                    valorTotal += (precoNum * p.estoque);

                    // L√≥gica da Data
                    let textoValidade = "Sem data";
                    let classeStatus = "status-ok"; 
                    let aviso = "";

                    if (p.validade) {
                        const dataObj = new Date(p.validade);
                        const dataUser = new Date(dataObj.getUTCFullYear(), dataObj.getUTCMonth(), dataObj.getUTCDate());
                        textoValidade = dataUser.toLocaleDateString('pt-PT');

                        if (dataUser < hoje) {
                            classeStatus = "status-vencido";
                            qtdVencidos++;
                            aviso = "‚ö†Ô∏è VENCIDO";
                        } 
                        else if ((dataUser - hoje) / (1000 * 60 * 60 * 24) < 30) {
                            classeStatus = "status-atencao";
                            aviso = "‚ö†Ô∏è Vence logo";
                        }
                    }
                    
                    divLista.innerHTML += `
                    <div class="item ${classeStatus}">
                        <div>
                            <strong>${p.nome}</strong> <small style="color:red; font-weight:bold;">${aviso}</small><br>
                            <span style="color: #555;">‚Ç¨ ${precoNum.toFixed(2)} | Qtd: ${p.estoque}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size:12px; font-weight:bold;">üìÖ ${textoValidade}</span>
                            <div style="margin-top: 5px;">
                                <button class="btn-mini" style="background:#2196F3;" onclick="editarProduto(${p.id}, '${p.preco}', '${p.estoque}')">‚úèÔ∏è</button>
                                <button class="btn-mini" style="background:#ff4444;" onclick="deletarProduto(${p.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
                });

                document.getElementById('dash-qtd').innerText = totalItens;
                document.getElementById('dash-valor').innerText = Number(valorTotal).toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
                document.getElementById('dash-vencidos').innerText = qtdVencidos;

            } catch (erro) {
                console.error(erro);
                document.getElementById('lista').innerHTML = '<p style="color:red">Erro ao carregar sistema.</p>';
            }
        }

        async function salvarProduto() {
            const nome = document.getElementById('nome').value;
            const preco = document.getElementById('preco').value;
            const estoque = document.getElementById('estoque').value;
            const validade = document.getElementById('validade').value;

            if(!nome || !preco) return alert("Preencha os dados!");

            await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, preco, estoque, validade })
            });

            document.location.reload();
        }

        async function deletarProduto(id) {
            if (confirm("Tem certeza que deseja apagar?")) {
                await fetch(`${API}/${id}`, { method: 'DELETE' });
                carregarLista();
            }
        }

        async function editarProduto(id, precoAtual, estoqueAtual) {
            const novoPreco = prompt("Novo Pre√ßo (‚Ç¨):", precoAtual);
            if (novoPreco === null) return;
            const novoEstoque = prompt("Novo Estoque:", estoqueAtual);
            if (novoEstoque === null) return;

            await fetch(`${API}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ preco: novoPreco, estoque: novoEstoque })
            });
            carregarLista();
        }

        carregarLista();
    </script>
</body>
</html>
