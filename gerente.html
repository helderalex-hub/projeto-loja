<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Gerente | Beleza & Cia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #fff0f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-add { background: #d63384; color: white; width: 100%; }
        .item { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #d63384; }
    </style>
</head>
<body>

    <button onclick="sair()" style="float:right;">Sair ðŸ”’</button>
    <h1>ðŸ’„ GestÃ£o de Stock</h1>

    <div class="card">
        <input type="text" id="nome" placeholder="Nome do Produto">
        <input type="number" id="preco" placeholder="PreÃ§o (â‚¬)">
        <input type="number" id="estoque" placeholder="Quantidade">
        <button class="btn-add" onclick="salvarProduto()">SALVAR AGORA</button>
    </div>

    <div id="lista">A carregar...</div>

    <script>
        // Chaves Diretas
        const S_URL = 'https://sgamfzcgiexoevnyiehn.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYW1memNnaWV4b2V2bnlpZWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzIwMDYsImV4cCI6MjA4NDUwODAwNn0.BLdnOWXEpW6w_Ic_0stcOexXXQBWl7Rc5ll0ATjvZVs';
        const API = 'https://projeto-loja-dzqv.onrender.com/produtos';

        const supabase = window.supabase.createClient(S_URL, S_KEY);

        // 1. VerificaÃ§Ã£o de Acesso imediata
        async function verificarSessao() {
            console.log("Checando sessÃ£o...");
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            } else {
                carregarLista();
            }
        }

        async function sair() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        async function carregarLista() {
            const div = document.getElementById('lista');
            try {
                const res = await fetch(API);
                const dados = await res.json();
                div.innerHTML = '';
                dados.forEach(p => {
                    div.innerHTML += `
                        <div class="item">
                            <span>${p.nome} - â‚¬${p.preco} (Stock: ${p.estoque})</span>
                            <button onclick="deletar(${p.id})" style="background:red; color:white;">X</button>
                        </div>`;
                });
            } catch (err) {
                div.innerHTML = "Erro ao carregar produtos. O Render estÃ¡ acordado?";
            }
        }

        async function salvarProduto() {
            const n = document.getElementById('nome').value;
            const p = document.getElementById('preco').value;
            const e = document.getElementById('estoque').value;

            if(!n || !p) return alert("Preencha Nome e PreÃ§o!");

            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nome: n, preco: p, estoque: e })
                });
                if(res.ok) {
                    document.getElementById('nome').value = '';
                    document.getElementById('preco').value = '';
                    document.getElementById('estoque').value = '';
                    carregarLista();
                }
            } catch (err) {
                alert("Erro ao salvar.");
            }
        }

        async function deletar(id) {
            if(confirm("Apagar?")) {
                await fetch(API + '/' + id, { method: 'DELETE' });
                carregarLista();
            }
        }

        // Tenta rodar assim que carregar
        window.onload = verificarSessao;
    </script>
</body>
</html>
