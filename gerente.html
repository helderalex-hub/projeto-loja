<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Pro | Beleza & Companhia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --dark: #1a1a1a; --card: #2d2d2d; --rosa: #d63384; --texto: #f5f5f5; --verde: #28a745; --azul: #2196F3; --amarelo: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--texto); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card-dash { background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #444; }
        .card-dash p { font-size: 24px; font-weight: bold; margin-top: 10px; }

        /* Form */
        .card-form { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #444; margin-bottom: 30px; }
        .camera-box { text-align: center; margin-bottom: 20px; }
        #preview-nova-foto { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 3px dashed #555; cursor: pointer; background: #000; }
        
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-size: 11px; color: #888; text-transform: uppercase; }
        input { width: 100%; padding: 12px; margin: 5px 0 15px; border-radius: 8px; border: 1px solid #444; background: #111; color: white; box-sizing: border-box; }
        
        #btnSalvar { background: var(--rosa); color: white; border: none; padding: 18px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        #btnSalvar:disabled { background: #555; cursor: not-allowed; }

        /* Lista */
        .item { background: var(--card); padding: 15px; margin-top: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid #444; }
        .img-lista { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .info { flex-grow: 1; }
        .btn-edit { background: var(--azul); border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: white; }
        .btn-del { background: #ff4444; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: white; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üíé Painel Financeiro</h1>
        
        <div class="dashboard">
            <div class="card-dash"><h3>Fatura√ß√£o Estimada</h3><p id="dash-fatura" style="color:var(--azul)">‚Ç¨ 0.00</p></div>
            <div class="card-dash"><h3>Custo Stock</h3><p id="dash-custo" style="color:var(--amarelo)">‚Ç¨ 0.00</p></div>
            <div class="card-dash"><h3>Margem Total</h3><p id="dash-margem" style="color:var(--verde)">‚Ç¨ 0.00</p></div>
        </div>

        <div class="card-form">
            <div class="camera-box">
                <img id="preview-nova-foto" src="https://via.placeholder.com/150?text=FOTO" title="Toque para foto">
                <input type="file" id="foto-input" accept="image/*" style="display: none;">
                <p style="font-size:10px; color:#888; margin-top:5px;">Clique na foto para capturar</p>
            </div>

            <label>Nome do Produto</label>
            <input type="text" id="nome">
            
            <div class="grid-form">
                <div><label>Custo (‚Ç¨)</label><input type="number" id="preco_entrada" step="0.01"></div>
                <div><label>Venda (‚Ç¨)</label><input type="number" id="preco" step="0.01"></div>
                <div><label>Stock</label><input type="number" id="estoque"></div>
            </div>
            
            <button id="btnSalvar">ADICIONAR PRODUTO</button>
        </div>

        <div id="lista">A carregar invent√°rio...</div>
    </div>

    <script>
        const API = 'https://projeto-loja-dzqv.onrender.com/produtos';
        const S_URL = 'https://sgamfzcgiexoevnyiehn.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYW1memNnaWV4b2V2bnlpZWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzIwMDYsImV4cCI6MjA4NDUwODAwNn0.BLdnOWXEpW6w_Ic_0stcOexXXQBWl7Rc5ll0ATjvZVs';
        const supabaseClient = window.supabase.createClient(S_URL, S_KEY);

        const preview = document.getElementById('preview-nova-foto');
        const fileInput = document.getElementById('foto-input');

        preview.onclick = () => fileInput.click();
        fileInput.onchange = () => {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => preview.src = e.target.result;
                reader.readAsDataURL(file);
            }
        };

        async function carregarDados() {
            try {
                const res = await fetch(API);
                const produtos = await res.json();
                const div = document.getElementById('lista');
                div.innerHTML = '';

                let fatura = 0, custoTotal = 0;

                produtos.forEach(p => {
                    const c = parseFloat(p.preco_entrada || 0);
                    const v = parseFloat(p.preco || 0);
                    const s = parseInt(p.estoque || 0);
                    fatura += (v * s);
                    custoTotal += (c * s);

                    const item = document.createElement('div');
                    item.className = 'item';
                    item.innerHTML = `
                        <img src="${p.imagem || 'https://via.placeholder.com/60'}" class="img-lista">
                        <div class="info">
                            <strong>${p.nome}</strong>
                            <p>Venda: ‚Ç¨${v.toFixed(2)} | Stock: ${s}</p>
                        </div>
                        <div>
                            <button class="btn-edit" onclick="editar('${p.id}', '${p.nome}', ${v}, ${c}, ${s})">‚úèÔ∏è</button>
                            <button class="btn-del" onclick="deletar('${p.id}')">üóëÔ∏è</button>
                        </div>
                    `;
                    div.appendChild(item);
                });

                document.getElementById('dash-fatura').innerText = '‚Ç¨ ' + fatura.toFixed(2);
                document.getElementById('dash-custo').innerText = '‚Ç¨ ' + custoTotal.toFixed(2);
                document.getElementById('dash-margem').innerText = '‚Ç¨ ' + (fatura - custoTotal).toFixed(2);
            } catch (e) { console.error(e); }
        }

        document.getElementById('btnSalvar').onclick = async () => {
            const btn = document.getElementById('btnSalvar');
            const nome = document.getElementById('nome').value;
            const c = document.getElementById('preco_entrada').value;
            const v = document.getElementById('preco').value;
            const s = document.getElementById('estoque').value;
            const arquivo = fileInput.files[0];

            if(!nome || !v) return alert("Preencha Nome e Pre√ßo de Venda!");
            
            btn.innerText = "A processar...";
            btn.disabled = true;

            try {
                let urlImg = "";
                if(arquivo) {
                    const nomeArq = `${Date.now()}_img.jpg`;
                    const { data, error } = await supabaseClient.storage.from('fotos-produtos').upload(nomeArq, arquivo);
                    if (error) throw error;
                    const { data: link } = supabaseClient.storage.from('fotos-produtos').getPublicUrl(nomeArq);
                    urlImg = link.publicUrl;
                }

                const res = await fetch(API, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        nome, 
                        preco_entrada: parseFloat(c) || 0, 
                        preco: parseFloat(v), 
                        estoque: parseInt(s) || 0, 
                        imagem: urlImg 
                    })
                });

                if (res.ok) {
                    // Limpa tudo e recarrega
                    document.getElementById('nome').value = '';
                    document.getElementById('preco_entrada').value = '';
                    document.getElementById('preco').value = '';
                    document.getElementById('estoque').value = '';
                    preview.src = "https://via.placeholder.com/150?text=FOTO";
                    carregarDados();
                } else {
                    alert("Erro ao gravar na Database. Verifique o servidor.");
                }
            } catch (e) {
                alert("Erro cr√≠tico: " + e.message);
            } finally {
                btn.innerText = "ADICIONAR PRODUTO";
                btn.disabled = false;
            }
        };

        async function editar(id, nome, v, c, s) {
            const nV = prompt("Novo Pre√ßo Venda:", v);
            const nC = prompt("Novo Custo:", c);
            const nS = prompt("Novo Stock:", s);
            if(nV !== null) {
                await fetch(`${API}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nome, preco: parseFloat(nV), preco_entrada: parseFloat(nC), estoque: parseInt(nS) })
                });
                carregarDados();
            }
        }

        async function deletar(id) {
            if(confirm("Apagar produto?")) {
                await fetch(`${API}/${id}`, { method: 'DELETE' });
                carregarDados();
            }
        }

        window.onload = carregarDados;
    </script>
</body>
</html>
