<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beleza & Cia | Loja Online</title>
    <style>
        body { font-family: 'Helvetica Neue', sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        
        header { text-align: center; margin-bottom: 40px; }
        h1 { color: #d63384; margin-bottom: 5px; }
        p.subtitle { color: #666; }

        .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        /* Card do Produto */
        .produto { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; transition: transform 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
        .produto:hover { transform: translateY(-5px); }
        
        .emoji { font-size: 60px; margin: 10px 0; display: block; }
        .nome { font-size: 18px; font-weight: bold; color: #333; margin: 10px 0; }
        .preco { font-size: 22px; color: #28a745; font-weight: bold; margin-bottom: 15px; }
        .estoque { font-size: 12px; color: #999; margin-bottom: 15px; }

        button { background-color: #d63384; color: white; border: none; padding: 12px; width: 100%; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #b02a6b; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Carrinho Flutuante */
        #carrinho-bar { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none; align-items: center; gap: 15px; cursor: pointer; z-index: 100; }
        #carrinho-bar:hover { transform: scale(1.05); }
    </style>
</head>
<body>

    <header>
        <h1>‚ú® Beleza & Cia</h1>
        <p class="subtitle">Os melhores produtos, agora em Euros.</p>
    </header>

    <div class="container" id="lista-produtos">
        <p style="text-align:center; width:100%;">Carregando produtos...</p>
    </div>

    <div id="carrinho-bar" onclick="finalizarCompra()">
        <span>üõí <b id="qtd-carrinho">0</b> itens</span>
        <span style="border-left: 1px solid #555; padding-left: 15px;">Ir para Pagamento ‚ûî</span>
    </div>

    <script>
        // SEU BACKEND NO RENDER
        const API_URL = 'https://projeto-loja-dzqv.onrender.com';
        
        let carrinho = [];
        let produtosGlobais = [];

        async function carregarLoja() {
            try {
                const response = await fetch(`${API_URL}/produtos`);
                produtosGlobais = await response.json();
                renderizar(produtosGlobais);
            } catch (error) {
                console.error("Erro ao carregar:", error);
                document.getElementById('lista-produtos').innerHTML = '<p>Erro ao carregar loja. Tente novamente.</p>';
            }
        }

        function renderizar(lista) {
            const div = document.getElementById('lista-produtos');
            div.innerHTML = '';

            lista.forEach(prod => {
                const precoNum = parseFloat(prod.preco);
                const semEstoque = prod.estoque <= 0;

                // IMPORTANTE: Aqui garantimos que o ID √© passado corretamente no clique
                div.innerHTML += `
                    <div class="produto">
                        <span class="emoji">üíÑ</span>
                        <div class="nome">${prod.nome}</div>
                        <div class="preco">‚Ç¨ ${precoNum.toFixed(2)}</div>
                        <div class="estoque">${semEstoque ? 'ESGOTADO' : 'Restam: ' + prod.estoque}</div>
                        <button onclick="adicionarAoCarrinho(${prod.id})" ${semEstoque ? 'disabled' : ''}>
                            ${semEstoque ? 'Indispon√≠vel' : 'Adicionar ao Carrinho'}
                        </button>
                    </div>
                `;
            });
        }

        function adicionarAoCarrinho(id) {
            // Procura o produto na lista original
            const produtoOriginal = produtosGlobais.find(p => p.id === id);
            
            if (!produtoOriginal) {
                alert("Erro: Produto n√£o encontrado!");
                return;
            }

            // CRIA UM NOVO OBJETO LIMPO PARA O CARRINHO
            // Isso garante que estamos a enviar APENAS o necess√°rio e que o ID est√° l√°
            const itemDoCarrinho = {
                id: produtoOriginal.id,
                nome: produtoOriginal.nome,
                preco: produtoOriginal.preco
            };

            // Verifica√ß√£o de Seguran√ßa
            if (!itemDoCarrinho.id) {
                alert("ERRO GRAVE: Este produto est√° sem ID no sistema. O estoque n√£o funcionar√°.");
                return;
            }

            carrinho.push(itemDoCarrinho);
            atualizarBarraCarrinho();
        }

        function atualizarBarraCarrinho() {
            const barra = document.getElementById('carrinho-bar');
            const qtd = document.getElementById('qtd-carrinho');
            qtd.innerText = carrinho.length;
            
            if (carrinho.length > 0) {
                barra.style.display = 'flex';
            } else {
                barra.style.display = 'none';
            }
        }

        async function finalizarCompra() {
            if(carrinho.length === 0) return;

            const btn = document.getElementById('carrinho-bar');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = 'Processando... ‚è≥';

            try {
                // LOG DE DEBUG PARA VOC√ä VER NO CONSOLE DO NAVEGADOR
                console.log("Enviando carrinho para o servidor:", carrinho);

                const resposta = await fetch(`${API_URL}/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itens: carrinho })
                });

                const dados = await resposta.json();
                
                if(dados.url) {
                    window.location.href = dados.url;
                } else {
                    alert('Erro ao criar pagamento: ' + (dados.error || 'Erro desconhecido'));
                    btn.innerHTML = textoOriginal;
                }
            } catch (error) {
                console.error(error);
                alert('Erro de conex√£o.');
                btn.innerHTML = textoOriginal;
            }
        }

        carregarLoja();
    </script>

</body>
</html>
